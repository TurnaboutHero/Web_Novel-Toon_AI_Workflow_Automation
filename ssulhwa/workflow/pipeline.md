# Episode Generation Pipeline v2

> 에피소드 자동 생성 파이프라인. 각 단계별 에이전트가 역할을 수행하고, 결과물을 다음 단계로 전달한다.
> v2 변경: 분량 강제 강화, 문미 변주 예시 추가, Stage 3 글자수 판정 제거 (Stage 6 전담), 감각 묘사 밀도 가이드 추가

---

## Pipeline Overview

```
[1. Context Assembly] → [2. Draft Generation] → [3. Style Review] → [4. Consistency Check] → [5. Revision] → [6. Final Validation]
```

---

## Stage 1: Context Assembly (컨텍스트 조립)

**담당**: 오케스트레이터 (직접 수행)
**목적**: 해당 에피소드에 필요한 참조 파일을 선별하여 컨텍스트 패키지를 구성

### 필수 컨텍스트 (매 에피소드)
| 파일 | 용도 | 포함 범위 |
|------|------|----------|
| `lore/episode-outline.md` | 해당 EP의 아웃라인 | 해당 EP + 직전 EP의 엔딩 훅 |
| `lore/style-guide.md` | 문체/형식 규칙 | 전체 |
| `lore/characters.md` | 등장 캐릭터 설정 | 해당 EP 등장 캐릭터만 추출 |
| `lore/world.md` | 세계관 규칙 | 해당 EP에 관련된 섹션만 추출 |

### 조건부 컨텍스트
| 조건 | 추가 파일 | 용도 |
|------|----------|------|
| 직전 에피소드 존재 | `episodes/EP-XX_*.md` | 연속성 확보 (마지막 500자) |
| 전투 씬 포함 | `world.md` > 에너지 체계 섹션 | 전투 묘사 규칙 |
| 새 장소 등장 | `world.md` > 거점/지리 섹션 | 장소 묘사 기준 |

---

## Stage 2: Draft Generation (초고 생성)

**담당**: executor 에이전트 (sonnet)
**목적**: 아웃라인 + 컨텍스트를 바탕으로 10,000자 분량의 에피소드 초고 작성

### 프롬프트 템플릿

```
당신은 웹소설 "설화(雪花)" 시즌1의 집필 에이전트입니다.

## 임무
아래 아웃라인과 참조 자료를 바탕으로 에피소드 본문을 작성하세요.

## 출력 규격
- **분량: 반드시 10,000자 내외 (9,000~11,000자). 9,000자 미만은 절대 불가.**
- **씬 구성: 3~5개 씬. 각 씬은 최소 2,000자 이상.**
- 형식: 마크다운 (# EP-XX: 제목 > 한줄요약 > --- > 본문 > --- > 다음 화 예고)
- [IMG] 마커: 3~5개 배치 (형식: [IMG:유형-설명])
- 씬 구분: --- 로 구분

### 분량 확보 전략 (중요)
분량이 부족하지 않도록 아래를 적극 활용하세요:
- 오감 묘사: 시각뿐 아니라 청각(소리), 촉각(감촉/온도), 후각(냄새), 미각을 섞어 장면 밀도를 높이세요
- 인물 내면: 행동 사이사이에 인물의 생각/감정/기억 회상을 삽입하세요
- 환경 디테일: 날씨, 빛의 변화, 공간의 분위기를 구체적으로 그려주세요
- 대사 전후 맥락: 대사 전에 화자의 표정/동작, 대사 후에 청자의 반응을 넣으세요
- 핵심 장면 확대: 아웃라인의 핵심 사건/감정 장면은 충분히 늘려서 독자가 "보는" 느낌이 들도록

## 문체 규칙 (반드시 준수)
1. 전지적 작가 시점. S1은 사일라즈 포커스 (프롤로그는 마일스/소피아 포커스)
2. 서정적/상세 묘사 기반 + 상황별 완급 조절
3. **문미 변화 필수 (가장 중요한 규칙)**:
   - "~였다/했다" 연속 2회도 지양. 절대 3연속 금지
   - 반드시 다양한 문미를 섞으세요:
     - 현재형: "~한다/~ㄴ다" (예: "바람이 분다", "검이 빛난다")
     - 명사형 종결: "~인 것" "~뿐" "~의 소리" (예: "차가운 금속의 감촉.", "멈출 수 없는 떨림.")
     - 수동/피동: "~된다/~아진다" (예: "시야가 흐려진다", "공기가 갈라진다")
     - 연결형/미완결: "~며" "~고" "~는데" (다음 문장으로 이어지는 호흡)
     - 대화체 삽입으로 리듬 변화
     - 도치/감탄: "아름다운 광경이었다" → "아름답다, 이 광경은."
   - **체크 방법**: 작성 후 연속된 3문장의 문미가 모두 "~다"로 끝나는 곳이 있으면 반드시 변주하세요
4. 비유/은유: 세계관 소재 활용 (별, 빛, 에너지, 시간, 계절)
5. 금지: 현대 인터넷 용어, 이모티콘, 메타 발언, "갑자기" 2회 초과
6. 지양: 세계관 설정을 대사로 직접 설명 (행동/상황으로 보여주기)
7. 캐릭터 말투 엄격 준수 (characters.md 참조)

## 에너지/전투 묘사 (전투 씬이 있을 경우)
- 마나: 변환 과정 묘사 ("마나가 열에너지로 바뀌며 손끝에서 불꽃이 피어올랐다")
- 우주 기운: 현실 간섭/왜곡 묘사 ("공간이 울렁이며 중력의 방향이 비틀렸다")
- 기: 신체 감각 묘사 ("호흡에 맞춰 근육 안을 흐르는 기류가 팔 끝까지 뻗었다")
- 3에너지 통합: 세 감각이 겹치는 묘사

## 아웃라인
{episode_outline}

## 직전 에피소드 엔딩 (연속성)
{previous_ending}

## 캐릭터 참조
{character_refs}

## 세계관 참조
{world_refs}
```

---

## Stage 3: Style Review (문체 리뷰)

**담당**: critic 에이전트 (opus) 또는 code-reviewer (sonnet)
**목적**: 초고가 style-guide.md 규칙을 준수하는지 검증

### 체크리스트
| # | 항목 | 기준 | 판정 |
|---|------|------|------|
| S1 | 문미 반복 | "~였다/했다/~다" 3연속 이하 | PASS/FAIL |
| S2 | 문장 리듬 | 현재형/명사형/수동형/대화체 등 다양한 문미 활용 | PASS/WARN |
| S3 | [IMG] 마커 | 3~5개, 형식 준수, 적절한 위치 | PASS/FAIL |
| S4 | 금지 표현 | 현대어/이모티콘/메타 없음 | PASS/FAIL |
| S5 | 캐릭터 말투 | characters.md 대조 일치 | PASS/FAIL |
| S6 | 시점 일관성 | 전지적 시점 + 포커스 캐릭터 | PASS/FAIL |
| S7 | 묘사 밀도 | 핵심 장면 풍부 / 전환 간결 / 오감 묘사 | PASS/WARN |
| S8 | "갑자기" 남발 | 2회 이하 | PASS/FAIL |
| S9 | 몰입도 | 서술이 지루하거나 늘어지는 구간 없는지 | PASS/WARN |
| S10 | 감정 전달 | 캐릭터 내면/감정이 독자에게 전달되는지 | PASS/WARN |

> **주의**: 글자 수/분량 검증은 이 단계에서 하지 않습니다. Stage 6에서 자동 검증합니다.
> **주의**: 마크다운 구조(제목/요약/예고)도 Stage 6에서 검증합니다.

### 프롬프트 템플릿

```
당신은 웹소설 "설화(雪花)"의 문체 품질 관리 에이전트입니다.

## 임무
아래 에피소드 초고의 **문체 품질**을 검토하세요.
글자 수/마크다운 형식은 검증하지 마세요 (별도 단계에서 자동 검증됨).
오직 문체, 묘사, 몰입감, 캐릭터 보이스에만 집중하세요.

## 체크리스트 (S1~S10)
각 항목별로 반드시 판정하세요:

S1. 문미 반복: 연속 3문장이 같은 패턴(~다/~했다/~였다)으로 끝나는 곳이 있는가?
S2. 문장 리듬: 현재형/명사형/수동형/대화체 등 다양한 문미가 활용되고 있는가?
S3. [IMG] 마커: 3~5개, [IMG:유형-설명] 형식, 적절한 위치에 배치되어 있는가?
S4. 금지 표현: 현대 인터넷 용어, 이모티콘, 메타 발언이 없는가?
S5. 캐릭터 말투: characters.md 설정과 일치하는가?
S6. 시점 일관성: 전지적 시점 + 포커스 캐릭터가 유지되는가?
S7. 묘사 밀도: 핵심 장면은 오감 묘사가 풍부하고, 전환은 간결한가?
S8. "갑자기" 남발: 2회 이하인가?
S9. 몰입도: 서술이 지루하거나 불필요하게 늘어지는 구간이 있는가?
S10. 감정 전달: 인물의 내면/감정이 독자에게 자연스럽게 전달되는가?

## 출력 형식
각 항목별:
- 판정: PASS / FAIL / WARN
- 근거: 구체적 위치(몇 번째 씬, 어떤 문장)와 문제 설명 (FAIL/WARN인 경우)
- 수정 제안: 구체적 대안 문장 (FAIL인 경우 필수)

## 최종 판정
- FAIL 0개 → "APPROVED" (WARN은 허용)
- FAIL 1개 이상 → "REVISION REQUIRED" + 수정 지시 목록

## 참조
{style_guide}
{characters_md}

## 초고
{draft}
```

---

## Stage 4: Consistency Check (일관성 검증)

**담당**: analyst 에이전트 (opus)
**목적**: 초고가 세계관/캐릭터/기존 에피소드와 모순 없는지 검증

### 체크리스트
| # | 항목 | 기준 | 판정 |
|---|------|------|------|
| C1 | 세계관 규칙 | world.md 위배 없음 | PASS/FAIL |
| C2 | 캐릭터 설정 | characters.md 위배 없음 | PASS/FAIL |
| C3 | 타임라인 | 시간순 모순 없음 | PASS/FAIL |
| C4 | 떡밥 일관성 | episode-outline.md의 떡밥과 충돌 없음 | PASS/FAIL |
| C5 | 에너지 체계 | 마법/전투 규칙 준수 | PASS/FAIL |
| C6 | 장소 묘사 | world.md 지리/거점과 일치 | PASS/FAIL |
| C7 | 직전 EP 연속성 | 엔딩 훅과 자연스럽게 이어짐 | PASS/FAIL |

### 프롬프트 템플릿

```
당신은 웹소설 "설화(雪花)"의 세계관 일관성 검증 에이전트입니다.

## 임무
아래 에피소드 초고가 세계관/캐릭터 설정과 모순되는 부분이 있는지 검토하세요.

## 출력 형식
각 항목별:
- 판정: PASS / FAIL
- 근거: 구체적 모순 지점 + 참조 문서의 해당 설정 인용
- 수정 제안: 모순 해결 방안

## 참조 문서
{world_md}
{characters_md}
{episode_outline}
{previous_episode}

## 초고
{draft}
```

---

## Stage 5: Revision (수정)

**담당**: executor 에이전트 (sonnet)
**목적**: Stage 3, 4에서 FAIL 판정된 항목을 수정

### 프롬프트 템플릿

```
당신은 웹소설 "설화(雪花)"의 원고 수정 에이전트입니다.

## 임무
아래 초고에서 리뷰 결과 지적된 문제점을 수정하세요.
수정은 최소 범위로 — 문제가 없는 부분은 그대로 유지하세요.

## 수정 지시
{review_results}

## 수정 규칙
1. 지적된 부분만 수정. 정상 부분은 변경 금지
2. 분량 유지 (±500자 이내)
3. [IMG] 마커 위치/개수 유지
4. 문체 톤 일관성 유지

## 초고
{draft}
```

---

## Stage 6: Final Validation (최종 검수)

**담당**: 오케스트레이터 (직접 수행) 또는 verifier 에이전트
**목적**: 최종 결과물의 수치적/형식적 검증

### 자동 체크 (Python 기반)
| # | 항목 | 방법 | 기준 |
|---|------|------|------|
| F1 | 글자 수 | Python `len()` (본문만, 마크다운 헤더/IMG/구분자 제외) | 9,000~11,000자 |
| F2 | [IMG] 마커 수 | `grep "\[IMG:"` | 3~5개 |
| F3 | 씬 구분자 수 | 파일 내 `---` 라인 카운트 | 3~6개 |
| F4 | 마크다운 구조 | `# EP-XX` 존재 | 1개 |
| F5 | 다음 화 예고 | `**다음 화 예고**` 존재 | 1개 |
| F6 | 문미 연속 체크 | Python: 연속 3문장 "~다" 종결 패턴 탐지 | 0개소 |

> **주의**: `wc -m`은 Windows/한글 환경에서 부정확. 반드시 Python으로 검증.

### PASS 조건
- F1~F5 전체 PASS → 최종 승인, 파일 저장
- 1개 이상 FAIL → Stage 5로 회귀 (최대 2회)

---

## Pipeline Execution Summary

```
Stage 1 (Context)  → 오케스트레이터 직접
Stage 2 (Draft)    → executor (sonnet)     → 초고.md
Stage 3 (Style)    → critic (sonnet)       → style_review.json
Stage 4 (Consist)  → analyst (sonnet)      → consistency_review.json
  ↓ (3,4 병렬 실행)
Stage 5 (Revise)   → executor (sonnet)     → 수정본.md  (FAIL 있을 때만)
Stage 6 (Validate) → 오케스트레이터 직접   → APPROVED / REJECTED
  ↓ (REJECTED → Stage 5 재실행, 최대 2회)
```

### 병렬 구간
- Stage 3 + Stage 4: 독립적이므로 **병렬 실행 가능**

### 최대 반복
- Stage 5 ↔ Stage 6 루프: **최대 2회**
- 2회 후에도 FAIL → 사람 검토로 전환
